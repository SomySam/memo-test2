rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 사용자 문서 규칙
    match /users/{email} {
      // 읽기: 본인만 가능
      allow read: if request.auth != null && request.auth.token.email == email;

      // 생성/수정: 본인만 가능하고, 필수 필드 검증
      allow create, update: if request.auth != null
                   && request.auth.token.email == email
                   && request.resource.data.uid is string
                   && request.resource.data.email is string
                   && request.resource.data.nickname is string
                   && request.resource.data.nickname.size() <= 50;

      // 삭제: 본인만 가능
      allow delete: if request.auth != null && request.auth.token.email == email;
    }

    // 메모 컬렉션 규칙
    match /memos/{email}/memo/{memoId} {
      // 읽기: 본인 메모만 가능
      allow read: if request.auth != null && request.auth.token.email == email;

      // 생성: 본인만 가능하고, 데이터 검증
      allow create: if request.auth != null
                    && request.auth.token.email == email
                    && request.resource.data.keys().hasAll(['content', 'createdAt', 'userId'])
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 10000
                    && request.resource.data.createdAt is number
                    && request.resource.data.userId == request.auth.uid;

      // 수정: 본인 메모만 가능하고, 필수 필드 유지
      allow update: if request.auth != null
                    && request.auth.token.email == email
                    && request.resource.data.content is string
                    && request.resource.data.content.size() > 0
                    && request.resource.data.content.size() <= 10000;

      // 삭제: 본인 메모만 가능
      allow delete: if request.auth != null && request.auth.token.email == email;
    }
  }
}
